<div class = "noteandweather">
<div id = "notepad">
  <div id = "notes"></div>

<button id="cleartasks">Clear Tasks</button>
</div>


<div id = "weather">
  <div>
    <h2>Current Weather</h2>
    <div class = "description"></div>
  </div>
</div>

</div>

<div class = "calendar_container">
<select id = "monthselect"></select>
<select id = "yearselect"></select>
<table id="calendar">
  <thead>
    <th>Sunday</th>
    <th>Monday</th>
    <th>Tuesday</th>
    <th>Wednesday</th>
    <th>Thursday</th>
    <th>Friday</th>
    <th>Saturday</th>
  </thead>
  <tbody id="calendar_days"></tbody>
</table>

<div id = "eventModal" class = "hide">
  <button id = "close">x</button>
  <input type="text" name="eventitem" id ="eventItem">
  <button id = "save">Save</button>
</div>

<div id = "editEventModal" class = "hide">
  <button id = "editclose">x</button>
  <input type="text" name="editEventitem" id ="editEventItem">
  <button id = "saveChanges">Save Changes</button>
</div>

<div id = "eventListModal" class = "hide">
  <button id = "eventClose">x</button>
  <ul id = "eventList"></ul>

</div>

<button id = "clear_storage">Clear Storage</button>
</div>


<style>
body{
  background: url(https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fi0.wp.com%2Fwww.innatthecrossroads.com%2Fwp-content%2Fuploads%2F2016%2F10%2FDark-Wood-Background.jpg%3Ffit%3D1024%252C768&f=1&nofb=1);
  background-size: 100% 100%;
}

.noteandweather{
  display:flex;
  height:20%;
}

.noteandweather div{
  width:50%;
}

#notepad{
 
}

#notes{
  display: flex;
  flex-direction: column;
  width:100%;
}

#notes input {
    border-radius: 5px;
    background: radial-gradient(#603E2B,#3a2112);
    border: 1px solid #6b4f40;
    box-shadow: inset 0px 0px 10px #211305;
    margin: 2px 0px;
    width:95%;
}

#weather{
  background: radial-gradient(#570000,black 90%);
  border-radius: 10px;
  color:white;
  text-align: center;
  display:flex;
}

#weather div:nth-child(1){
  width:80%;
}

#weather h2{
  font-family: cursive;
  margin-bottom: 0;
}

#weather .description{
  margin:auto;
}

#weather img{
  width:100px;
  filter: sepia(1);
}

#cleartasks{
}

.calendar_container{
  height:70%;
}

#calendar{
  border-collapse: collapse;
  table-layout:fixed;
  width:100%;
  height:100%;
}

#calendar ul{
  list-style-type: none;
  padding-left: 2px;
  margin:0;
  width:100%;
  overflow-y: auto;
  max-height: 40px;
}

#calendar ul li div{
  float:right;
  height:13px;
  width:13px;
  font-size:13px;
  padding:1px;
  background:white;
  border-radius:1px;
  margin:1px;
  text-align:center;
  font-family:arial;
  color:black;
}

#calendar ul div img{
  width:100%;
  height:100%;
}

#calendar li{
  margin:2px 0px;
  width:95%;
  background:maroon;
  color:white;
}

th{
  height:20px;
  background:maroon;
  color:#f1e3bf;
  box-shadow: 0px 0px 10px #3e1111;
}

th,td{
  border:1px solid black;
  overflow:hidden;
  vertical-align: baseline;
  border:0;
}

td{
  height:50px;
  background: url(https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fcdn.pixabay.com%2Fphoto%2F2017%2F05%2F20%2F18%2F20%2Fflourish-2329481_640.png&f=1&nofb=1),radial-gradient(beige,tan);
  box-shadow: inset 0px 0px 10px #9f702e;
  background-position: left bottom, center;
  background-size: 20px 20px, 100% 100%;
  background-repeat:no-repeat;
  background-blend-mode:overlay;

}

#eventModal, #editEventModal, #eventListModal{
  border:1px solid black;
  width:200px;
  height:200px;
  margin: 0;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background:white;
}

.hide{
  display:none;
}

#calendar ul.mobileList{
  border-radius:50%;
  width: 70%;
  padding-top: 70%;
  background:radial-gradient(red,maroon);
}

#calendar ul li.mobileList{
    display:block;
    background:maroon;
    position:absolute;
    width:80px;
}


@media only screen and (max-width:400px){  

  #weather h2{
    font-size:15px;
  }

  #weather .description{
    font-size:12px;
  }

  #calendar ul li{
    display:none;
  }

  
}
</style>


<script>

var arr = {};
var arrayman;
var notes = document.getElementById("notes");
var count = 1;
var clearbutton = document.getElementById("cleartasks");
clearbutton.addEventListener("click",cleartasks,false);

if(window.localStorage.getItem("persons")){
  var arrayman = JSON.parse(window.localStorage.getItem("persons"));
    for(var key in arrayman){
      var inputblock =  document.createElement("input");
               inputblock.addEventListener("keyup",changeValue,false);
      inputblock.setAttribute("id", "n" + count);
      inputblock.value = arrayman[key];
      count++;
      notes.append(inputblock);
  } 
}else{
  var arr = {"n1":"","n2":"","n3":"","n4":"","n5":""};
     for(var key in arr){
      var inputblock =  document.createElement("input");
  inputblock.addEventListener("keyup",changeValue,false);
      inputblock.setAttribute("id", key);
      notes.append(inputblock);
  } 
  localStorage.setItem('persons', JSON.stringify(arr));
}




var persons = JSON.parse(localStorage.persons);


function changeValue(){
  persons[this.id] = this.value; 
      
  localStorage.setItem("persons", JSON.stringify(persons));  //put the object back

}


function cleartasks(){
  localStorage.clear();
  var notes = notes.getElementsByTagName("input");
  
  for(var i = 0; i < notes.length;i++){
    notes[i].value = "";
  }
}

var weather = document.getElementById("weather");
var el = document.getElementById("weather").getElementsByClassName("description")[0];

/*Weather*/

var xhr = new XMLHttpRequest();

xhr.open("GET", "https://api.openweathermap.org/data/2.5/weather?lat=40.177780&lon=-74.584290&appid=f73299cc3d3bcb102e545dc126c5fa2c"); 

xhr.send();


//  Add a listener function to respond to the HTTP response
xhr.addEventListener("readystatechange", function(){
    if(this.readyState == 4 && this.status == 200){
        var message = JSON.parse(this.response);
        var temp = Math.round(1.8*(message.main.temp - 273) + 32) + " FÂ°";
        var icon = document.createElement("img");
        icon.setAttribute("src",'http://openweathermap.org/img/wn/' + message.weather[0].icon + '.png');
      var newmessage = message.weather[0].description + '<br>' + "Temperature: " + temp;
      el.innerHTML = newmessage;
      weather.appendChild(icon);
    }
});







//Calendar javascript

var calendar = document.getElementById("calendar_days");
//dropdowns
var monthSelect = document.getElementById("monthselect");
var yearSelect = document.getElementById("yearselect");
var eventModal = document.getElementById("eventModal");
var editEventModal = document.getElementById("editEventModal");
var closeButton = document.getElementById("close");
var editclose = document.getElementById("editclose");
var saveButton = document.getElementById("save");
var saveChanges = document.getElementById("saveChanges");
var eventItem = document.getElementById("eventItem");
var editEventItem = document.getElementById("editEventItem");
var clearStorage = document.getElementById("clear_storage");
var d;
var eventDates = [];
var dayIndexforSave;
var eventsMonthYear;
var editItemListItem;
var lists;
var previousListThis;

var months = ["January","February","March","April","May","June","July","August","September","October","November","December"];

var days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

var years = [2019,2020,2021,2022,2023];

function detectMobile(){
    lists = document.getElementById("calendar").getElementsByTagName("ul");
    if(screen.width < 400 || document.body.clientWidth < 400){
        
      for(var i = 0; i < lists.length; i++){
           if(lists[i].firstChild){
                lists[i].classList.add("mobileList");
           }
      }
    }else{
        for(var i = 0; i < lists.length; i++){
           if(lists[i].firstChild){
                lists[i].classList.remove("mobileList");
           }
            for(var k = 0; k < lists[i].children.length; k++){
                lists[i].children[k].classList.remove("mobileList");
            }
        }

    }
}


function monthLength (month, year) {
    return new Date(year, month, 0).getDate();
}

function generateTime(month,year){
  var daysInMonth = monthLength(month+1,year);

  var row = document.createElement("tr");
  calendar.append(row);

for(var i = 1; i <= daysInMonth; i++){
    d = new Date(year,month,i);
  
    if(d.getDay() == 0 && i != 1){
      row = document.createElement("tr");
      calendar.append(row);
    } 
  
    if(i == 1){
      for(let i=0; i < d.getDay(); i++){
        let block = document.createElement("td");
        row.append(block);
      }
      addDayBlock(row,i);

    }else{
      addDayBlock(row,i);
    }
  }
  
  addEventsToCalendar();
}

function addDayBlock(newrow,i){
      let block = document.createElement("td");
      let blockNum = document.createTextNode(i);
      let eventBlock = document.createElement("ul");
      block.append(blockNum);
      block.append(eventBlock);
      block.addEventListener("click",addEvent,false);
      newrow.append(block);
}


function populateSelect(poparray,select){
  let newarray = poparray;
  let newselect = select;
  
  for(var i = 0; i < newarray.length; i++) {
    var optionValue = newarray[i];
    var option = document.createElement("option");
    option.value = optionValue;
    option.textContent = optionValue;
    newselect.appendChild(option);
  }
}

function clearMonth(){
  while(calendar.children.length > 0){ 
    calendar.children[0].remove();
  }
}

function selectTime(){
  clearMonth();
  let newMonth = months.indexOf(monthSelect.value);
  let newYear = yearSelect.value;
  generateTime(newMonth,newYear);
  detectMobile();
}


function addEvent(){
  //bubbling and capturing
  if(event.target == this){
     dayIndexforSave = this.firstChild.data;
     eventModal.classList.remove("hide");
     monthSelect.setAttribute("disabled", "true");
     yearSelect.setAttribute("disabled", "true");
  }

}

function close(){
  this.parentNode.classList.add("hide");
  monthSelect.removeAttribute("disabled");
  yearSelect.removeAttribute("disabled");
}

function saveEvent(){
  if(window.localStorage.getItem("retrieveEvent")){
  eventDates = JSON.parse(window.localStorage.getItem("retrieveEvent"));  
}

if(eventItem.value){
  
  if(eventDates.length == 0){
    eventDates[0] = {};
    eventDates[0].month = monthSelect.value;
    eventDates[0].year = yearSelect.value; 
    eventDates[0][dayIndexforSave] = [eventItem.value];
    var savedEvent = JSON.stringify(eventDates);
    window.localStorage.setItem("retrieveEvent", savedEvent);
    eventItem.value = "";
    eventModal.classList.add("hide");
    monthSelect.removeAttribute("disabled");
    yearSelect.removeAttribute("disabled");
  }else{
    
    for(var i = 0; i < eventDates.length; i++){
      if(eventDates[i].month == monthSelect.value && eventDates[i].year == yearSelect.value){
         if(eventDates[i][dayIndexforSave]){
        
            eventDates[i][dayIndexforSave].push(eventItem.value);
            break;
         }else{

           eventDates[i][dayIndexforSave] = [eventItem.value];
           break;
          }
     
      }else if(i == eventDates.length-1){
          eventDates[eventDates.length] = {};
          eventDates[eventDates.length-1].month = monthSelect.value;
          eventDates[eventDates.length-1].year = yearSelect.value; 
          eventDates[eventDates.length-1][dayIndexforSave] = [eventItem.value];
          break;
      }
       
      
    }
  }
  
    var savedEvent = JSON.stringify(eventDates);
    window.localStorage.setItem("retrieveEvent", savedEvent);
    addEventToBlock();
    eventItem.value = "";
    detectMobile();
 }

    eventModal.classList.add("hide");
    monthSelect.removeAttribute("disabled");
    yearSelect.removeAttribute("disabled");

 console.dir(eventDates);
}

function addEventToBlock(){
   for(var i = 0; i < eventDates.length; i++){
      if(eventDates[i].month == monthSelect.value && eventDates[i].year == yearSelect.value){
          var eventsMonthYear = eventDates[i];
      }
   }
            
  for(let j = 0; j < calendar.children.length; j++){              
    for(let k = 0; k < calendar.children[j].childNodes.length; k++){
  
      if(calendar.children[j].childNodes[k].firstChild){
            var calendarIndex = calendar.children[j].childNodes[k].firstChild.data;
        
        if(calendarIndex == dayIndexforSave){

          let eventBlock = calendar.children[j].childNodes[k].childNodes[1];
          var listItem = document.createElement("li");
          let attributeIndex = String(dayIndexforSave);
          var deleteButton = document.createElement("div");
          deleteButton.addEventListener("click",deleteEvent,false);
          deleteButton.textContent = "X";
          var editButton = document.createElement("div");   
          editButton.addEventListener("click",openEditEvent,false);
          editButton.innerHTML = "<img src = 'pen.png'/>";

          var textArrayLength = eventsMonthYear[dayIndexforSave].length-1;
          listItem.textContent = eventsMonthYear[dayIndexforSave][textArrayLength];

          listItem.append(deleteButton);
          listItem.append(editButton);
          eventBlock.addEventListener("click",openEventList,false);
          eventBlock.appendChild(listItem); 

          
        }
       }
    }
                  
  }
  eventModal.classList.add("hide");
  monthSelect.removeAttribute("disabled");
  yearSelect.removeAttribute("disabled");  
}



function addEventsToCalendar(){
  if(window.localStorage.getItem("retrieveEvent")){
       eventDates = JSON.parse(window.localStorage.getItem("retrieveEvent"));
  }
  
  
  for(var i = 0; i < eventDates.length; i++){
    if(eventDates[i].month == monthSelect.value && eventDates[i].year == yearSelect.value){
          eventsMonthYear = eventDates[i];
        for(let j = 0; j < calendar.children.length; j++){              
          for(let k = 0; k < calendar.children[j].childNodes.length; k++){
            if(calendar.children[j].childNodes[k].firstChild){
               var index = calendar.children[j].childNodes[k].firstChild.data;
               var eventBlock = calendar.children[j].childNodes[k].childNodes[1];  
              if( eventsMonthYear[index]){
                  for(var l = 0; l <  eventsMonthYear[index].length; l++){
       

                    var listItem = document.createElement("li");
                    let attributeIndex = String(dayIndexforSave);
                    var deleteButton = document.createElement("div");
                    deleteButton.addEventListener("click",deleteEvent,false);
                    deleteButton.textContent = "X";
                    var editButton = document.createElement("div");   
                    editButton.addEventListener("click",openEditEvent,false);
                    editButton.innerHTML = "<img src = 'pen.png'/>";
                    deleteButton.textContent = "X";
                    listItem.textContent =  eventsMonthYear[index][l];
                    listItem.append(deleteButton);
                    listItem.append(editButton);
                    eventBlock.addEventListener("click",openEventList,false);
                    eventBlock.appendChild(listItem); 
                  }
           }
            
          }
        
        }
      
      }
    }
  }
      

 }
  



function deleteEvent(){
  var evt = this;
  var index = this.parentNode.parentNode.parentNode.childNodes[0].data;

  for(var i = 0; i < eventDates.length; i++){
    if(eventDates[i].month == monthSelect.value && eventDates[i].year == yearSelect.value)  {
      var eventMonthYear = eventDates[i];
      var listLength = this.parentNode.parentNode.childNodes.length;
       for(var j = 0; j < listLength; j++){
        
           if(this.parentNode.parentNode.childNodes[j] == this.parentNode){
             if(eventMonthYear[index].length >= 2){

                eventMonthYear[index].splice(j, eventMonthYear[index].length-1);
               break;
             }else{
                delete eventMonthYear[index];
               break;
             }
               
           }
         
       }

    } 
  }

    this.parentNode.remove();

    var savedEvent = JSON.stringify(eventDates);
    window.localStorage.setItem("retrieveEvent", savedEvent);
  
}

function openEditEvent(){
  dayIndexforSave = this.parentNode.parentNode.parentNode.firstChild.data;
  editItemListItem = this;
  editEventModal.classList.remove("hide");
  monthSelect.setAttribute("disabled", "true");
  yearSelect.setAttribute("disabled", "true");
}

function editEvent(){
  var evt = editItemListItem;
  var index = dayIndexforSave;
  for(var i = 0; i < eventDates.length; i++){
    if(eventDates[i].month == monthSelect.value && eventDates[i].year == yearSelect.value)  {
      var eventMonthYear = eventDates[i];
      var listLength = editItemListItem.parentNode.childNodes.length;
       for(var j = 0; j < listLength; j++){
           if(editItemListItem.parentNode.parentNode.childNodes[j] == editItemListItem.parentNode){
               eventMonthYear[index][j] = editEventItem.value;
               break;             
           }
         
       }

    } 
  }

  editItemListItem.parentNode.firstChild.data = editEventItem.value;

  var savedEvent = JSON.stringify(eventDates);
  window.localStorage.setItem("retrieveEvent", savedEvent);
  editEventItem.value = "";
  editEventModal.classList.add("hide");
  monthSelect.removeAttribute("disabled");
  yearSelect.removeAttribute("disabled");
}


function openEventList(){
  if(event.target == this){

    if(previousListThis){
      for(var k = 0; k < previousListThis.children.length; k++){
        console.log();
        previousListThis.children[k].classList.remove("mobileList");
      }
    }


    lists = this.children;
    if(screen.width < 400 || document.body.clientWidth < 400){
        
      for(var i = 0; i < lists.length; i++){
           if(lists[i].firstChild){
                lists[i].classList.add("mobileList");
           }
      }
    }
      previousListThis = this;
  }


}


window.addEventListener('resize', detectMobile,false);
monthSelect.addEventListener("change",selectTime,false);
yearSelect.addEventListener("change",selectTime,false);
closeButton.addEventListener("click",close,false);
editclose.addEventListener("click",close,false);
saveButton.addEventListener("click",saveEvent,false);
clearStorage.addEventListener("click",function(){localStorage.clear();location.reload();},false);
saveChanges.addEventListener("click",editEvent,false);

populateSelect(months,monthSelect);
populateSelect(years,yearSelect);
generateTime(months.indexOf(monthSelect.value),yearSelect.value);



detectMobile();
</script>